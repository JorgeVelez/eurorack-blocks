name: Ubuntu 20.04

on:
  pull_request:
    branches: [ main ]

jobs:
  hardware:
    name: Hardware
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - run: sudo apt-get update
      - run: sudo apt-get install kicad
      - run: python blocks/audio-in-daisy/build.py
      - run: python blocks/audio-out-daisy/build.py
      - run: python blocks/button/build.py
      - run: python blocks/cv-in/build.py
      - run: python blocks/gate-in/build.py
      - run: python blocks/gate-out/build.py
      - run: python blocks/led/build.py
      - run: python blocks/led-bi/build.py
      - run: python blocks/multiplexer/build.py
      - run: python blocks/pot/build.py
      - run: python blocks/power-bus/build.py
      - run: python blocks/regulator-daisy/build.py
      - run: python blocks/slider/build.py
      - run: python blocks/switch/build.py
      - run: python blocks/trim/build.py
      - run: python blocks/kits/stats.py
      - run: python blocks/kits/build.py

  software:
    name: Software
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - run: sudo apt-get update
      - run: sudo apt-get install gcc-arm-none-eabi
      - run: sudo apt-get install -y ninja-build
      - run: sudo apt-get install libglu1-mesa-dev
      - run: sudo apt install libcairo2-dev libffi-dev python3-dev

      # Install either dfu-util or openocd:
      # - dfu-util allows to upload firmware by connecting Daisy with a USB cable
      # - openocd requires STLink, like STLINK-V3MINI
      #   Read documentation in documentation/stlink
      - run: sudo apt install dfu-util  # using USB
      - run: sudo apt install openocd   # using JTAG

      - run: pip install cairosvg cairocffi
      - run: pip install ezdxf
      - run: mkdir -p ~/.local/share/fonts/
      - run: cp include/erb/vcvrack/design/d-din/*.otf ~/.local/share/fonts
      - run: cp include/erb/vcvrack/design/indie-flower/*.ttf ~/.local/share/fonts
      - run: python blocks/test/configure.py
      - run: python blocks/test/build.py
      - run: python test/field/configure.py
      - run: python test/field/build.py
      - run: python test/micropatch/configure.py
      - run: python test/micropatch/build.py
      - run: python samples/drop/configure.py
      - run: python samples/drop/build.py
      - run: python samples/drop/build.py --erb-target vcvrack

  unit_tests:
    name: Unit Tests
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - run: sudo apt-get update
      - run: sudo apt-get install -y ninja-build
      - run: python test/unit/configure.py
      - run: python test/unit/build.py
      - run: python test/unit/run.py

  erbb_tests:
    name: Erbb/Erbui Tests
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - run: sudo apt-get update
      - run: sudo apt-get install libglu1-mesa-dev
      - run: sudo apt install libcairo2-dev libffi-dev python3-dev
      - run: sudo apt-get install kicad
      - run: pip install cairosvg cairocffi
      - run: pip install ezdxf
      - run: pip install coverage
      - run: mkdir -p ~/.local/share/fonts/
      - run: cp include/erb/vcvrack/design/d-din/*.otf ~/.local/share/fonts
      - run: cp include/erb/vcvrack/design/indie-flower/*.ttf ~/.local/share/fonts
      - run: python build-system/test.py
      - run: python build-system/cover.py
      - run: python test/vcvrack/configure.py
      - run: python test/vcvrack/build.py
